## 4 - 文件和目录

### 1. 函数 stat、fstat、fstatat 和 lstat

```c++
#inlcude <sys/stat.h>
int stat(const char *restrict pathname, struct stat *restrict buf);
int fstat(int fd, struct stat *buf);
int lstat(const char *restrict pathname, struct stat *restrict buf);
int fstatat(int fd, const char *restrict pathname, struct stat *restrict buf, int flag);
```

**stat** 函数返回与 $pathname$ 文件有关的信息结构。

**fstat** 函数获取已在文件描述符 $fd$ 上打开文件的有关信息。

**lstat** 函数在 $pathname$ 是一个符号链接时，返回该符号链接的有关信息，而不是由该符号链接引用的文件的信息。

**fstatat** 函数为相对于 $fd$ 路径的相对路径名 $pathname$ 返回文件统计信息。当 $fd$ 参数的值是 `AT_FDCWD` ，并且 $pathname$ 参数是一个相对路径名，函数会计算相对于当前目录的 $pathname$ 参数。如果 $pathname$ 是一个绝对路径，$fd$ 参数会被忽略，此函数与 **stat** 或 **lstat** 一样。$flag$ 参数控制着是否跟随一个符号链接，当 `AT_SYMLINK_NOFLLOW` 标志被设置时，函数返回符号链接本身信息，否则返回符号链接指向的文件的信息。

$buf$ 是一个指针，指向包含文件统计信息的结构体 **stat** 。

### 2. 文件类型

- **普通文件 (regular file)**：最常用的文件类型，包含了某种形式的数据。
- **目录文件 (directory file)**：这种文件包含了其他文件的名字以及指向这些文字有关信息的指针。内核可以直接写目录，进程必须通过一些函数才能更改目录。
- **块特殊文件 (block special file)**：提供对设备（如磁盘）带缓冲的访问，每次访问以固定长度为单位进行。
- **字符特殊文件 (character special file)**：提供对设备不带缓冲的访问，每次访问长度可变。系统中设备要么是字符特殊文件，要么是块特殊文件。
- **FIFO**：也称为 **命名管道 (named pipe)** ，这种类型的文件用于进程间通信。
- **套接字 (socket)**：这种类型文件用于进程间的网络通信，也可用于在一台宿主机上进程间的非网络通信。
- **符号链接 (symbolic link)**：这种类型的文件指向另一个文件。

文件类型包含在 **stat** 结构的 **st_mode** 成员中。

### 3. 设置用户ID和设置组ID

与一个 **进程** 相关联的 **ID** 如下图所示：

![](./img/4-78.png)

- **实际用户ID** 和 **实际组 ID** 标识我们究竟是谁，在一个登录会话期间这些值并不改变。
- **有效用户** 、**有效组ID** 以及 **附属组ID** 决定了文件访问权限。通常，有效用户ID等于实际用户ID，有效组ID等于实际组ID。但是可通过设置 **stat** 文件模式字 **st_mode** 中的 **设置用户ID位** 和 **设置组ID位** ，将进程有效用户ID设置为 **文件所有者的用户ID (st_uid)** ，将有效组ID设置为 **文件的组所有者ID (st_gid)** ，通过这种方式，若文件所有者为超级用户，可将一个进程设置为超级用户权限，无论执行此文件的进程的实际用户ID是什么。
- **保存的设置用户ID** 和 **保存的设置组ID** 在执行一个程序时包含了有效用户ID和有效组ID。







